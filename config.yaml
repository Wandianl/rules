http:
  timeout: 20s
  max-concurrent-downloads: 6
  keep-alive: true
  user-agent: "clash-meta/1.18.0"

proxy_provider_anchor: &proxy_provider
  use: ["✨魔法"]

smart_config: &smart_config
  uselightgbm: true
  collectdata: true
  weight_algorithm: 
    base_weight: 0.55
    success_factor: 0.39
    latency_factor: -0.42
    stability_factor: 0.33
    adaptive_weight: true
    weight_decay: 0.92
    update_interval: 40
  safety_cutoff:
    min_success_rate: 0.82
    max_latency: 777
    recovery_time: 240
    progressive_recovery: true
    recovery_stages: [60,120,240]
    penalty_multiplier: 1.3
    circuit_breaker:
      failure_threshold: 3
      success_threshold: 2
      timeout: 30

health_check_anchor: &health_check
  enable: true
  interval: 160
  timeout: 2333
  expected-status: "200,204,206"
  method: "HEAD"
  urls:
    - "https://cp.cloudflare.com"
    - "https://www.google.com/generate_204"
    - "https://detectportal.firefox.com/success.txt"
  concurrent: true
  max-failed: 2

smart_group_template: &smart_group
  type: smart
  <<: [*proxy_provider, *smart_config]
  interval: 240
  health-check: 
    <<: *health_check
  max-concurrent-per-node: 80
  auto-switch: true
  switch-threshold: 0.77

base_group: &base
  type: select
  proxies: ["🧠 智能选择", "🇭🇰 香港", "🇹🇼 台湾", "🇯🇵 日本", "🇸🇬 新加坡", "🇺🇸 美国",  "🛣️ 直连", "🚫 拒绝"]

proxy-providers:
  ✨魔法:
    url: "代理"
    type: http
    interval: 43200
    hidden: true
    health-check:
      <<: *health_check
    proxy: "🛣️ 直连"

proxies:
  - name: "🛣️ 直连"
    type: direct
  - name: "🚫 拒绝"
    type: reject

port: 7890
socks-port: 7891
redir-port: 7892
mixed-port: 7893
tproxy-port: 7894
allow-lan: true
bind-address: "*"
ipv6: false
unified-delay: true
tcp-concurrent: true
log-level: warning
find-process-mode: off
global-client-fingerprint: chrome

profile: 
  store-selected: true
  store-fake-ip: true
  store-cache-file: true

external-controller: 0.0.0.0:9090
secret: ""
external-ui: "/etc/nikki/run/ui"
external-ui-name: Zashboard
external-ui-url: "https://github.com/Zephyruso/zashboard/archive/refs/heads/gh-pages.zip"

tun:
  enable: true
  stack: system
  dns-hijack: ["any:53", "tcp://any:53"]
  mtu: 1400
  routing-mark: 666
  strict-route: false
  endpoint-independent-nat: false
  auto-redirect: true
  auto-detect-interface: true
  inet4-route-address: ["0.0.0.0/1", "128.0.0.0/1"]
  inet6-route-address: ["::/1", "8000::/1"]

dns:
  enable: true
  listen: 0.0.0.0:1053
  ipv6: false
  enhanced-mode: fake-ip
  fake-ip-range: 198.18.0.0/15
  fake-ip-filter-mode: blacklist
  fake-ip-filter: [
    "geosite:cn", "+.local", "+.lan", "*.internal",
    "localdomain", "*.localdomain", "*.localhost",
    "*.msftncsi.com", "dns.msftncsi.com","*.msftconnecttest.com",
    "*.prod.do.dsp.mp.microsoft.com", "*.cdn.cloudflare.com", "*.dns.google"
  ]
  cache-size: 1024
  max-ttl: 1200
  min-ttl: 15
  respect-rules: true
  default-nameserver: ["223.5.5.5", "119.29.29.29"]
  proxy-server-nameserver: ["https://dns.google/dns-query", "https://dns.alidns.com/dns-query"]
  nameserver: ["223.5.5.5", "119.29.29.29"]
  concurrent-resolver: 3
  resolver-strategy: prefer-ipv4
  preload-domains: [    "google.com", "youtube.com", "github.com",
    "discord.com", "telegram.org"]

connection: 
  max-connections: 100
  max-stream-connections: 20
  buffer-size: 256
  timeout: 160
  connection-reuse: true
  keep-alive-pool-size: 100
  idle-timeout: 80

tcp: 
  keep-alive-interval: 30
  keep-alive-timeout: 120
  fast-open: true
  no-delay: true
  window-scaling: true
  selective-ack: true
  timestamps: true
  mss: 1460

udp: 
  timeout: 60
  disable-congestion: true
  buffer-size: 65536
  batch-processing: true

system: 
  nf-conntrack-max: 512
  nf-conntrack-timeout: 120
  ip-local-port-range: "10000 65535"
  tcp-rmem: "4096 87380 16777216"
  tcp-wmem: "4096 16384 16777216"
  tcp-congestion-control: "bbr2"

sniffer:
  enable: true
  safety_cutoff:
    max_failure: 2
    recovery_time: 120
  sniff: 
    HTTP: {ports: [80, 8080], override-destination: false}
    TLS: {ports: [443, 8443]}
    QUIC: {ports: [443, 80]}
  skip-domain: [
    "geosite:cn",
    "geosite:private",
    "+.local",
    "localhost",
    "*.localhost",
    "*.lan",
    "*.internal",
    "localdomain",
    "*.localdomain",
    "*.msftncsi.com",
    "dns.msftncsi.com",
    "*.msftconnecttest.com",
    "*.corp",
    "*.intranet",
    "*.office",
    "*.router",
    "*.nas",
    "*.printer"
  ]

  force-domain: [
    "+.google.com", "+.youtube.com", "+.github.com",
    "+.telegram.org"
  ]

proxy-groups:
  - name: "🌍 国外"
    <<: *base
    
  - name: "🇨🇳 国内"
    type: select
    proxies: ["🛣️ 直连", "🧠 智能选择"]

  - name: "🕸️ 漏网"
    type: select
    proxies: ["🛣️ 直连", "🧠 智能选择", "🚫 拒绝"]
    
  - name: "📢 广告"
    type: select
    proxies: ["🚫 拒绝", "🛣️ 直连"]

  - name: "🧠 智能选择"
    <<: *smart_group
    filter: ""
    learning-mode: true
    smart-strategy:
      auto-switch: true
      switch-threshold: 0.83
    hidden: true
    
  - name: "🇭🇰 香港"
    <<: *smart_group
    filter: "香港|HK"
    hidden: true

  - name: "🇹🇼 台湾"
    <<: *smart_group
    filter: "台湾|TW"
    hidden: true

  - name: "🇯🇵 日本"
    <<: *smart_group
    filter: "日本|JP"
    hidden: true

  - name: "🇸🇬 新加坡"
    <<: *smart_group
    filter: "新加坡|SG"
    hidden: true

  - name: "🇺🇸 美国"
    <<: *smart_group
    filter: "美国|US"
    hidden: true

rules:
  - RULE-SET,reject-domain,📢 广告
  - SRC-IP-CIDR,192.168.10.100/32,🛣️ 直连
  - RULE-SET,direct-domain,🛣️ 直连
  - RULE-SET,proxy-domain,🌍 国外
  - MATCH,🧠 智能选择,no-resolve

rule-anchor:
  ip: &ip {type: http, interval: 86400, behavior: ipcidr, format: mrs}
  domain: &domain {type: http, interval: 86400, behavior: domain, format: mrs}

rule-providers:
  direct-domain: 
    <<: *domain
    url: "https://github.com/dfghyuhgf/rules/raw/refs/heads/main/direct-domain.mrs"
    
  proxy-domain: 
    <<: *domain
    url: "https://github.com/dfghyuhgf/rules/raw/refs/heads/main/proxy-domain.mrs"
    
  reject-domain: 
    <<: *domain
    url: "https://github.com/dfghyuhgf/rules/raw/refs/heads/main/reject-domain.mrs"

tcp-cc: bbr2
enable-process: true
tcp-fast-open: true
udp-priority: true
max-concurrent-requests: 180
max-http-connections: 30

rule-config:
  enable-cache: true
  cache-size: 8MB
  auto-update: true
  update-threshold: 5%
  rule-compression: true
  compression-level: 7

rule-cache:
  enable: true
  max-size: 512
  ttl: 1200
  cache-strategy: arc
  cache-compression: true
  preload: 
    - "direct-domain"
    - "proxy-domain"
  hot-cache:
    enable: true
    threshold: 50
    boost-factor: 2

memory-optimizer:
  rule-compression: true
  compression-level: 8
  memory-monitoring: true
  memory-threshold: 55
  gc-optimization:
    enable: true
    interval: 120
    aggressive-mode: false
  memory-pool:
    enable: true
    pool-size: 8MB
    buffer-reuse: true
  idle-memory-release: 
    enable: true
    threshold: 30
    interval: 300

security:
  access-control:
    enable: true
    whitelist: ["192.168.0.0/16", "10.0.0.0/8", "172.16.0.0/12"]
  api-security:
    rate-limit: 200
    auth-required: false
    cors-enabled: false

name: Mihomoè§„åˆ™é›†è‡ªåŠ¨è½¬æ¢

on:
  schedule:
    - cron: '0 7 * * *'  # æ¯æ—¥7ç‚¹æ‰§è¡Œ
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'å¼ºåˆ¶é‡æ–°æ„å»ºæ‰€æœ‰è§„åˆ™'
        required: false
        default: 'false'
        type: boolean
  push:
    branches: [ main ]
    paths: 
      - 'rules_config.txt'
      - '.github/workflows/convert-rules.yml'

env:
  MIHOMO_TIMEOUT: 120
  GO_VERSION: '1.21'
  RULES_DIR: 'rules'
  OUTPUT_DIR: 'output'
  CONFIG_FILE: 'rules_config.txt'

jobs:
  validate-config:
    name: éªŒè¯é…ç½®æ–‡ä»¶
    runs-on: ubuntu-latest
    outputs:
      config-valid: ${{ steps.validate.outputs.valid }}
      rule-groups: ${{ steps.validate.outputs.groups }}
    
    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4
      
    - name: éªŒè¯é…ç½®æ–‡ä»¶
      id: validate
      run: |
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "âŒ é”™è¯¯: $CONFIG_FILE é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
          echo "è¯·åˆ›å»ºé…ç½®æ–‡ä»¶ï¼Œæ ¼å¼: è§„åˆ™ç»„å è§„åˆ™ç±»å‹ ä¸‹è½½URL è¾“å‡ºæ–‡ä»¶å"
          echo "è§„åˆ™ç±»å‹: domain(åŸŸåè§„åˆ™) æˆ– ipcidr(IPè§„åˆ™)"
          echo "valid=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        echo "âœ… é…ç½®æ–‡ä»¶å­˜åœ¨ï¼Œå¼€å§‹éªŒè¯æ ¼å¼..."
        line_num=0
        valid_lines=0
        declare -A output_files
        declare -A rule_types
        
        while IFS= read -r line || [ -n "$line" ]; do
          line_num=$((line_num + 1))
          
          # è·³è¿‡æ³¨é‡Šè¡Œå’Œç©ºè¡Œ
          if [[ "$line" =~ ^[[:space:]]*# ]] || [[ -z "${line// }" ]]; then
            continue
          fi
          
          # è§£æé…ç½®è¡Œ
          read -r name rule_type url output_file <<< "$line"
          
          if [ -z "$name" ] || [ -z "$rule_type" ] || [ -z "$url" ] || [ -z "$output_file" ]; then
            echo "âŒ ç¬¬ $line_num è¡Œæ ¼å¼é”™è¯¯: $line"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # éªŒè¯è§„åˆ™ç±»å‹
          if [[ "$rule_type" != "domain" && "$rule_type" != "ipcidr" ]]; then
            echo "âŒ ç¬¬ $line_num è¡Œè§„åˆ™ç±»å‹é”™è¯¯: '$rule_type'ï¼Œåªæ”¯æŒ 'domain' æˆ– 'ipcidr'"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # éªŒè¯URLæ ¼å¼
          if [[ ! "$url" =~ ^https?:// ]]; then
            echo "âŒ ç¬¬ $line_num è¡ŒURLæ ¼å¼é”™è¯¯: $url"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # æ£€æŸ¥åŒä¸€è¾“å‡ºæ–‡ä»¶çš„è§„åˆ™ç±»å‹ä¸€è‡´æ€§
          if [ -n "${rule_types[$output_file]}" ] && [ "${rule_types[$output_file]}" != "$rule_type" ]; then
            echo "âŒ è¾“å‡ºæ–‡ä»¶ '$output_file' åŒ…å«ä¸åŒç±»å‹çš„è§„åˆ™"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          rule_types[$output_file]="$rule_type"
          output_files[$output_file]="${output_files[$output_file]} $url"
          valid_lines=$((valid_lines + 1))
          
          echo "âœ… ç¬¬ $line_num è¡Œ: $name ($rule_type) -> $output_file"
        done < "$CONFIG_FILE"
        
        if [ $valid_lines -eq 0 ]; then
          echo "âŒ é…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„è§„åˆ™é…ç½®"
          echo "valid=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        echo "âœ… é…ç½®éªŒè¯é€šè¿‡ï¼Œæ‰¾åˆ° $valid_lines æ¡æœ‰æ•ˆè§„åˆ™é…ç½®"
        echo "valid=true" >> $GITHUB_OUTPUT
        
        # è¾“å‡ºè§„åˆ™ç»„ä¿¡æ¯ä¾›åç»­æ­¥éª¤ä½¿ç”¨
        groups_json="{"
        first=true
        for output_file in "${!output_files[@]}"; do
          if [ "$first" = false ]; then
            groups_json+=","
          fi
          groups_json+="\"$output_file\":{\"type\":\"${rule_types[$output_file]}\",\"urls\":\"${output_files[$output_file]}\"}"
          first=false
        done
        groups_json+="}"
        echo "groups=$groups_json" >> $GITHUB_OUTPUT

  setup-mihomo:
    name: å®‰è£…Mihomo
    runs-on: ubuntu-latest
    needs: validate-config
    if: needs.validate-config.outputs.config-valid == 'true'
    outputs:
      mihomo-version: ${{ steps.install.outputs.version }}
      
    steps:
    - name: ç¼“å­˜MihomoäºŒè¿›åˆ¶æ–‡ä»¶
      id: cache-mihomo
      uses: actions/cache@v4
      with:
        path: /usr/local/bin/mihomo
        key: mihomo-${{ runner.os }}-${{ hashFiles('**/go.mod') }}
        restore-keys: mihomo-${{ runner.os }}-
        
    - name: å®‰è£…Mihomo
      id: install
      if: steps.cache-mihomo.outputs.cache-hit != 'true'
      run: |
        echo "ğŸ”„ è·å–Mihomoæœ€æ–°ç‰ˆæœ¬..."
        LATEST_VERSION=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | \
          grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
        
        if [ -z "$LATEST_VERSION" ]; then
          echo "âŒ æ— æ³•è·å–Mihomoç‰ˆæœ¬ä¿¡æ¯"
          exit 1
        fi
        
        echo "ğŸ“¦ æœ€æ–°ç‰ˆæœ¬: $LATEST_VERSION"
        echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT
        
        # å°è¯•å¤šç§ä¸‹è½½æ–¹å¼
        download_success=false
        
        # æ–¹å¼1: å…¼å®¹ç‰ˆæœ¬
        if wget -q -O mihomo.gz "https://github.com/MetaCubeX/mihomo/releases/download/${LATEST_VERSION}/mihomo-linux-amd64-compatible-${LATEST_VERSION}.gz"; then
          echo "âœ… ä¸‹è½½å…¼å®¹ç‰ˆæœ¬æˆåŠŸ"
          download_success=true
        # æ–¹å¼2: æ ‡å‡†ç‰ˆæœ¬
        elif wget -q -O mihomo.gz "https://github.com/MetaCubeX/mihomo/releases/download/${LATEST_VERSION}/mihomo-linux-amd64-${LATEST_VERSION}.gz"; then
          echo "âœ… ä¸‹è½½æ ‡å‡†ç‰ˆæœ¬æˆåŠŸ"
          download_success=true
        # æ–¹å¼3: Dockeræå–
        else
          echo "ğŸ³ ä½¿ç”¨Dockeræå–äºŒè¿›åˆ¶æ–‡ä»¶..."
          if docker pull metacubex/mihomo:latest && \
             docker create --name mihomo_temp metacubex/mihomo:latest && \
             docker cp mihomo_temp:/mihomo ./mihomo && \
             docker rm mihomo_temp; then
            echo "âœ… Dockeræå–æˆåŠŸ"
            download_success=true
          fi
        fi
        
        if [ "$download_success" != true ]; then
          echo "âŒ æ‰€æœ‰ä¸‹è½½æ–¹å¼éƒ½å¤±è´¥äº†"
          exit 1
        fi
        
        # è§£å‹å’Œå®‰è£…
        if [ -f mihomo.gz ]; then
          gzip -d mihomo.gz
        fi
        
        chmod +x mihomo
        sudo mv mihomo /usr/local/bin/mihomo
        
        # éªŒè¯å®‰è£…
        if mihomo -v 2>/dev/null || mihomo --version 2>/dev/null; then
          echo "âœ… Mihomoå®‰è£…æˆåŠŸ"
        else
          echo "âŒ Mihomoå®‰è£…éªŒè¯å¤±è´¥"
          exit 1
        fi

  convert-rules:
    name: è½¬æ¢è§„åˆ™é›†
    runs-on: ubuntu-latest
    needs: [validate-config, setup-mihomo]
    if: needs.validate-config.outputs.config-valid == 'true'
    
    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4
      
    - name: æ¢å¤Mihomoç¼“å­˜
      uses: actions/cache@v4
      with:
        path: /usr/local/bin/mihomo
        key: mihomo-${{ runner.os }}-${{ hashFiles('**/go.mod') }}
        fail-on-cache-miss: true
        
    - name: åˆ›å»ºå·¥ä½œç›®å½•
      run: |
        mkdir -p "$RULES_DIR" "$OUTPUT_DIR"
        echo "ğŸ“ å·¥ä½œç›®å½•åˆ›å»ºå®Œæˆ"
        
    - name: å®‰è£… yq å·¥å…·
      run: |
        sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        sudo chmod +x /usr/local/bin/yq
        yq --version
        
    - name: ä¸‹è½½å’Œå¤„ç†è§„åˆ™æ–‡ä»¶
      run: |
        echo "ğŸ”„ å¼€å§‹å¤„ç†è§„åˆ™æ–‡ä»¶..."
        
        # è§£æé…ç½®æ–‡ä»¶
        declare -A rule_groups
        declare -A rule_types
        
        while IFS= read -r line || [ -n "$line" ]; do
          # è·³è¿‡æ³¨é‡Šè¡Œå’Œç©ºè¡Œ
          if [[ "$line" =~ ^[[:space:]]*# ]] || [[ -z "${line// }" ]]; then
            continue
          fi
          
          read -r name rule_type url output_file <<< "$line"
          
          rule_types[$output_file]="$rule_type"
          if [ -z "${rule_groups[$output_file]}" ]; then
            rule_groups[$output_file]="$url"
          else
            rule_groups[$output_file]="${rule_groups[$output_file]} $url"
          fi
        done < "$CONFIG_FILE"
        
        # è§„åˆ™å¤„ç†å‡½æ•°
        process_domain_rules() {
          local file="$1"
          local output="$2"
          
          # æ£€æµ‹æ–‡ä»¶æ ¼å¼
          if grep -q "^payload:" "$file"; then
            echo "      ğŸ“‹ æ£€æµ‹åˆ° YAML æ ¼å¼"
            # ä½¿ç”¨ yq å¤„ç† YAML æ ¼å¼
            yq eval '.payload[]' "$file" 2>/dev/null | \
              sed 's/^['\''\"]//' | sed 's/['\''\"]*$//' | \
              grep -v '^[[:space:]]*$' | \
              grep -E '^(\+\.)?[a-zA-Z0-9*.-]+(\.[a-zA-Z]{2,})?$' | \
              sort -u >> "$output"
          else
            echo "      ğŸ“‹ æ£€æµ‹åˆ°çº¯æ–‡æœ¬æ ¼å¼"
            # å¤„ç†çº¯æ–‡æœ¬æ ¼å¼
            grep -v '^[[:space:]]*#' "$file" | \
              grep -v '^[[:space:]]*$' | \
              sed 's/^[[:space:]]*//' | \
              sed 's/[[:space:]]*$//' | \
              grep -E '^(\+\.)?[a-zA-Z0-9*.-]+(\.[a-zA-Z]{2,})?$' | \
              sort -u >> "$output"
          fi
        }
        
        process_ipcidr_rules() {
          local file="$1"
          local output="$2"
          
          # æ£€æµ‹æ–‡ä»¶æ ¼å¼
          if grep -q "^payload:" "$file"; then
            echo "      ğŸ“‹ æ£€æµ‹åˆ° YAML æ ¼å¼"
            # ä½¿ç”¨ yq å¤„ç† YAML æ ¼å¼
            yq eval '.payload[]' "$file" 2>/dev/null | \
              sed 's/^['\''\"]//' | sed 's/['\''\"]*$//' | \
              grep -v '^[[:space:]]*$' | \
              grep -E '^([0-9]{1,3}\.){3}[0-9]{1,3}(/[0-9]{1,2})?$|^[0-9a-fA-F:]+:[0-9a-fA-F:]*(/[0-9]{1,3})?$' | \
              sort -u >> "$output"
          else
            echo "      ğŸ“‹ æ£€æµ‹åˆ°çº¯æ–‡æœ¬æ ¼å¼"
            # å¤„ç†çº¯æ–‡æœ¬æ ¼å¼
            grep -v '^[[:space:]]*#' "$file" | \
              grep -v '^[[:space:]]*$' | \
              sed 's/^[[:space:]]*//' | \
              sed 's/[[:space:]]*$//' | \
              grep -E '^([0-9]{1,3}\.){3}[0-9]{1,3}(/[0-9]{1,2})?$|^[0-9a-fA-F:]+:[0-9a-fA-F:]*(/[0-9]{1,3})?$' | \
              sort -u >> "$output"
          fi
        }
        
        # å¤„ç†æ¯ä¸ªè§„åˆ™ç»„
        total_groups=${#rule_groups[@]}
        current_group=0
        
        for output_file in "${!rule_groups[@]}"; do
          current_group=$((current_group + 1))
          urls="${rule_groups[$output_file]}"
          rule_type="${rule_types[$output_file]}"
          
          echo ""
          echo "ğŸ“‹ [$current_group/$total_groups] å¤„ç†è§„åˆ™ç»„: $output_file"
          echo "   ç±»å‹: $rule_type"
          echo "   æºæ–‡ä»¶æ•°é‡: $(echo $urls | wc -w)"
          
          # åˆ›å»ºåˆå¹¶æ–‡ä»¶
          merged_file="$RULES_DIR/${output_file}_merged.txt"
          > "$merged_file"
          
          # ä¸‹è½½å’Œæ¸…ç†æ¯ä¸ªURLçš„è§„åˆ™
          url_count=0
          for url in $urls; do
            url_count=$((url_count + 1))
            echo "   ğŸ”— [$url_count] ä¸‹è½½: $(basename "$url")"
            
            temp_file="$RULES_DIR/temp_$(basename "$url")"
            
            if wget -q --timeout=30 --tries=3 -O "$temp_file" "$url"; then
              echo "      âœ… ä¸‹è½½æˆåŠŸ"
              
              # æ˜¾ç¤ºåŸå§‹æ–‡ä»¶å‰å‡ è¡Œç”¨äºè°ƒè¯•
              echo "      ğŸ” åŸå§‹æ–‡ä»¶ç¤ºä¾‹:"
              head -5 "$temp_file" | sed 's/^/         /'
              
              # è®°å½•å¤„ç†å‰çš„è¡Œæ•°
              before_count=$(wc -l < "$merged_file" 2>/dev/null || echo "0")
              
              # æ ¹æ®è§„åˆ™ç±»å‹è¿›è¡Œå¤„ç†
              if [ "$rule_type" = "domain" ]; then
                process_domain_rules "$temp_file" "$merged_file"
              elif [ "$rule_type" = "ipcidr" ]; then
                process_ipcidr_rules "$temp_file" "$merged_file"
              fi
              
              # è®¡ç®—å¤„ç†çš„è§„åˆ™æ•°
              after_count=$(wc -l < "$merged_file" 2>/dev/null || echo "0")
              processed_count=$((after_count - before_count))
              
              echo "      ğŸ“Š å¤„ç†äº† $processed_count æ¡æœ‰æ•ˆè§„åˆ™"
              
              # å¦‚æœæ²¡æœ‰å¤„ç†åˆ°æœ‰æ•ˆè§„åˆ™ï¼Œæ˜¾ç¤ºæ›´å¤šè°ƒè¯•ä¿¡æ¯
              if [ "$processed_count" -eq 0 ]; then
                echo "      âš ï¸ æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆè§„åˆ™ï¼Œè°ƒè¯•ä¿¡æ¯:"
                echo "         æ–‡ä»¶å¤§å°: $(wc -l < "$temp_file") è¡Œ"
                echo "         æ£€æµ‹æ ¼å¼:"
                if grep -q "^payload:" "$temp_file"; then
                  echo "         - å‘ç° YAML æ ¼å¼æ ‡è®°"
                  echo "         - å°è¯•æå– payload å†…å®¹:"
                  yq eval '.payload[]' "$temp_file" 2>/dev/null | head -3 | sed 's/^/           /'
                else
                  echo "         - çº¯æ–‡æœ¬æ ¼å¼"
                  echo "         - éç©ºè¡Œç¤ºä¾‹:"
                  grep -v '^[[:space:]]*$' "$temp_file" | head -3 | sed 's/^/           /'
                fi
              fi
              
              rm -f "$temp_file"
            else
              echo "      âŒ ä¸‹è½½å¤±è´¥"
              rm -f "$temp_file"
              exit 1
            fi
          done
          
          # éªŒè¯åˆå¹¶ç»“æœ
          total_rules=$(wc -l < "$merged_file" 2>/dev/null || echo "0")
          if [ "$total_rules" -eq 0 ]; then
            echo "   âŒ é”™è¯¯: æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆè§„åˆ™"
            echo "   ğŸ” è°ƒè¯•ä¿¡æ¯ - åˆå¹¶æ–‡ä»¶å†…å®¹:"
            if [ -f "$merged_file" ]; then
              head -10 "$merged_file" | sed 's/^/      /' || echo "      æ–‡ä»¶ä¸ºç©º"
            else
              echo "      åˆå¹¶æ–‡ä»¶ä¸å­˜åœ¨"
            fi
            exit 1
          fi
          
          # å»é‡å¹¶ç»Ÿè®¡æœ€ç»ˆè§„åˆ™æ•°
          sort -u "$merged_file" -o "$merged_file"
          final_rules=$(wc -l < "$merged_file")
          
          echo "   ğŸ“ˆ åˆå¹¶åæ€»è§„åˆ™æ•°: $final_rules"
          echo "   ğŸ“‹ è§„åˆ™ç¤ºä¾‹:"
          head -3 "$merged_file" | sed 's/^/      /'
          
          # è½¬æ¢ä¸ºMihomoæ ¼å¼
          echo "   ğŸ”„ å¼€å§‹è½¬æ¢ä¸ºäºŒè¿›åˆ¶æ ¼å¼..."
          
          convert_start_time=$(date +%s)
          if timeout "$MIHOMO_TIMEOUT" mihomo convert-ruleset "$rule_type" text "$merged_file" "$OUTPUT_DIR/$output_file"; then
            convert_end_time=$(date +%s)
            convert_duration=$((convert_end_time - convert_start_time))
            echo "   âœ… è½¬æ¢æˆåŠŸ (è€—æ—¶: ${convert_duration}s)"
            
            # éªŒè¯è¾“å‡ºæ–‡ä»¶
            if [ -f "$OUTPUT_DIR/$output_file" ] && [ -s "$OUTPUT_DIR/$output_file" ]; then
              file_size=$(stat -f%z "$OUTPUT_DIR/$output_file" 2>/dev/null || stat -c%s "$OUTPUT_DIR/$output_file")
              echo "   ğŸ“ è¾“å‡ºæ–‡ä»¶: $output_file (${file_size} å­—èŠ‚)"
            else
              echo "   âŒ è¾“å‡ºæ–‡ä»¶æ— æ•ˆæˆ–ä¸ºç©º"
              exit 1
            fi
          else
            echo "   âŒ è½¬æ¢å¤±è´¥ (è¶…æ—¶: ${MIHOMO_TIMEOUT}s)"
            echo "   ğŸ” è°ƒè¯•ä¿¡æ¯ - è§„åˆ™æ–‡ä»¶æœ«å°¾:"
            tail -5 "$merged_file" | sed 's/^/      /'
            exit 1
          fi
        done
        
        echo ""
        echo "ğŸ‰ æ‰€æœ‰è§„åˆ™è½¬æ¢å®Œæˆ!"
        echo "ğŸ“Š ç”Ÿæˆæ–‡ä»¶ç»Ÿè®¡:"
        ls -lah "$OUTPUT_DIR"/ | grep -v "^total" | while read -r line; do
          echo "   $line"
        done

    - name: ç”Ÿæˆæ„å»ºæŠ¥å‘Š
      run: |
        report_file="$OUTPUT_DIR/build-report.md"
        
        cat > "$report_file" << EOF
        # Mihomoè§„åˆ™é›†æ„å»ºæŠ¥å‘Š
        
        **æ„å»ºæ—¶é—´:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        **Mihomoç‰ˆæœ¬:** ${{ needs.setup-mihomo.outputs.mihomo-version }}
        **è§¦å‘æ–¹å¼:** ${{ github.event_name }}
        
        ## ç”Ÿæˆçš„è§„åˆ™é›†
        
        EOF
        
        for file in "$OUTPUT_DIR"/*.mrs; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            filesize=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file")
            filesize_mb=$(echo "scale=2; $filesize / 1024 / 1024" | bc 2>/dev/null || echo "N/A")
            echo "- **$filename** - ${filesize} bytes (${filesize_mb} MB)" >> "$report_file"
          fi
        done
        
        echo "" >> "$report_file"
        echo "## ä½¿ç”¨æ–¹æ³•" >> "$report_file"
        echo "" >> "$report_file"
        echo '```yaml' >> "$report_file"
        echo 'rule-providers:' >> "$report_file"
        
        for file in "$OUTPUT_DIR"/*.mrs; do
          if [ -f "$file" ]; then
            filename=$(basename "$file" .mrs)
            echo "  $filename:" >> "$report_file"
            echo "    type: http" >> "$report_file"
            echo "    format: mrs" >> "$report_file"
            # æŒ‡å‘ä»“åº“mainåˆ†æ”¯çš„åŸå§‹æ–‡ä»¶
            echo "    url: https://github.com/${{ github.repository }}/raw/main/$(basename "$file")" >> "$report_file"
            echo "    interval: 86400" >> "$report_file"
            echo "" >> "$report_file"
          fi
        done
        
        echo '```' >> "$report_file"

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: mihomo-rules-${{ github.run_number }}
        path: |
          ${{ env.OUTPUT_DIR }}/*.mrs
          ${{ env.OUTPUT_DIR }}/build-report.md
        retention-days: 30
        compression-level: 9

  commit-updates:
    name: æäº¤è§„åˆ™æ–‡ä»¶
    runs-on: ubuntu-latest
    needs: [convert-rules]
    if: |
      always() && 
      needs.convert-rules.result == 'success' &&
      github.event_name != 'pull_request'
    
    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: mihomo-rules-${{ github.run_number }}
        path: artifacts/
        
    - name: æ›´æ–°è§„åˆ™æ–‡ä»¶
      run: |
        echo "ğŸ“ å¤åˆ¶æ–°çš„è§„åˆ™æ–‡ä»¶..."
        
        # å¤åˆ¶mrsæ–‡ä»¶åˆ°ä»“åº“æ ¹ç›®å½•
        if ls artifacts/*.mrs 1> /dev/null 2>&1; then
          cp artifacts/*.mrs ./ 2>/dev/null || true
          echo "âœ… è§„åˆ™æ–‡ä»¶å·²æ›´æ–°"
        else
          echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ°mrsæ–‡ä»¶"
        fi
        
        # å¤åˆ¶æ„å»ºæŠ¥å‘Š
        if [ -f "artifacts/build-report.md" ]; then
          cp artifacts/build-report.md ./
          echo "âœ… æ„å»ºæŠ¥å‘Šå·²æ›´æ–°"
        fi

    - name: æ£€æŸ¥å¹¶æäº¤å˜æ›´
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        
        # æ·»åŠ æ‰€æœ‰å˜æ›´
        git add *.mrs build-report.md 2>/dev/null || true
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if [ -n "$(git status --porcelain)" ]; then
          echo "ğŸ“ å‘ç°å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
          
          commit_msg="ğŸ¤– è‡ªåŠ¨æ›´æ–°Mihomoè§„åˆ™é›†
          
          - æ„å»ºæ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - æ„å»ºå·: #${{ github.run_number }}
          - è§„åˆ™æ–‡ä»¶: $(ls -1 *.mrs 2>/dev/null | wc -l) ä¸ª
          - è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          
          git commit -m "$commit_msg"
          git push
          
          echo "âœ… å˜æ›´å·²æäº¤å¹¶æ¨é€"
        else
          echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´ï¼Œè·³è¿‡æäº¤"
        fi

  cleanup:
    name: æ¸…ç†èµ„æº
    runs-on: ubuntu-latest
    needs: [convert-rules, commit-updates]
    if: always()
    
    steps:
    - name: æ¸…ç†æ—§çš„æ„å»ºäº§ç‰©
      uses: geekyeggo/delete-artifact@v5
      with:
        name: mihomo-rules-*
        useGlob: true
        failOnError: false
        
    - name: è¾“å‡ºæ„å»ºæ‘˜è¦
      run: |
        echo "## ğŸ¯ æ„å»ºå®Œæˆæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| é¡¹ç›® | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| é…ç½®éªŒè¯ | ${{ needs.validate-config.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Mihomoå®‰è£… | ${{ needs.setup-mihomo.result == 'success' && 'âœ… å®Œæˆ' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| è§„åˆ™è½¬æ¢ | ${{ needs.convert-rules.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| æäº¤æ›´æ–° | ${{ needs.commit-updates.result == 'success' && 'âœ… å®Œæˆ' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æ„å»ºæ—¶é—´:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
        echo "**æ„å»ºç¼–å·:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY

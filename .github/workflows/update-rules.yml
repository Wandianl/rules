name: Update Clash Rules for Mihomo

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-rules:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: pip install requests pyyaml
        
    - name: Convert rules with wildcards
      run: |
        python -c "
        import requests
        import yaml
        import re

        def process_domain(domain):
            domain = str(domain).strip(\"' \")
            # 保留原始通配符格式
            if domain.startswith('*.'):
                return f'DOMAIN-SUFFIX,{domain}'
            # 普通域名也转为DOMAIN-SUFFIX
            return f'DOMAIN-SUFFIX,{domain}'

        def convert_to_mrs(url, output_filename):
            print(f'Processing {url}...')
            response = requests.get(url)
            response.raise_for_status()
            
            domains = []
            try:
                data = yaml.safe_load(response.text)
                domains = data.get('payload', [])
            except:
                domains = [line.strip() for line in response.text.splitlines() 
                         if line.strip() and not line.startswith('#')]
            
            with open(output_filename, 'w', encoding='utf-8', newline='\n') as f:
                for item in domains:
                    try:
                        rule = process_domain(item)
                        if not re.search(r'\.', rule.split(',')[1]):
                            continue
                        f.write(f'{rule}\n')
                    except Exception as e:
                        print(f'Skipping invalid entry: {item} - {e}')

        convert_to_mrs(
            'https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/proxy.txt',
            'proxy.mrs'
        )
        "
        
    - name: Validate output
      run: |
        echo "=== 文件前10行验证 ==="
        head -n 10 proxy.mrs
        echo "=== 格式检查 ==="
        ! grep -vE '^(DOMAIN-SUFFIX,\*?\.[a-z0-9-]+|[#])' proxy.mrs || (echo "发现格式错误行" && exit 1)
        
    - name: Commit and push
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add *.mrs
        git commit -m "Update rules with wildcards [$(date +'%Y-%m-%d')]" || echo "No changes"
        git push

name: Generate Optimized MRS Rules with Docker

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTCæ—¶é—´00:00è¿è¡Œ
  workflow_dispatch:     # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main

jobs:
  generate-mrs-rules:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Docker
      run: |
        # ä½¿ç”¨å®˜æ–¹æ–¹æ³•å®‰è£…Docker
        sudo apt-get update
        sudo apt-get install -y ca-certificates curl gnupg
        sudo install -m 0755 -d /etc/apt/keyrings
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
        sudo chmod a+r /etc/apt/keyrings/docker.gpg
        
        # æ·»åŠ Dockerå®˜æ–¹ä»“åº“
        echo \
          "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
          $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
          sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
        
        # å®‰è£…Docker
        sudo apt-get update
        sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
        
        # éªŒè¯å®‰è£…
        sudo docker run hello-world
        
    - name: Download and convert rules
      run: |
        # åˆ›å»ºè§„åˆ™ç›®å½•
        mkdir -p rules
        
        # å®šä¹‰è§„åˆ™ç±»å‹
        types=("direct" "proxy" "reject")
        
        for type in "${types[@]}"; do
          # ä¸‹è½½åŸå§‹è§„åˆ™
          url="https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/${type}.txt"
          echo "ğŸ“¥ Downloading $url..."
          curl -s -o "${type}.yaml" "$url"
          
          # æå–åŸŸå
          echo "ğŸ”„ Extracting domains for ${type}..."
          # ä½¿ç”¨å¯é çš„æå–æ–¹æ³•
          grep -E "^  - '" "${type}.yaml" | sed "s/^  - '//;s/'$//" > "${type}.txt"
          
          # ç¡®ä¿æ–‡ä»¶ä¸ä¸ºç©º
          if [ ! -s "${type}.txt" ]; then
            echo "âŒ Error: ${type}.txt is empty after extraction!"
            echo "Original file preview:"
            head -n 5 "${type}.yaml"
            exit 1
          fi
          
          # ç¡®ä¿æ‰€æœ‰åŸŸåéƒ½æœ‰é€šé…ç¬¦
          awk '{
            if ($0 !~ /^\*/) {
              print "*." $0
            } else {
              print $0
            }
          }' "${type}.txt" > "${type}-processed.txt"
          
          echo "First 3 domains:"
          head -3 "${type}-processed.txt"
          
          # ä½¿ç”¨ Docker Hub ä¸Šçš„ Mihomo é•œåƒ
          echo "âš™ï¸ Generating MRS for ${type}..."
          sudo docker run --rm -v $(pwd):/data metacubex/mihomo:alpha \
            rule-set -format text -o "/data/rules/${type}.mrs" "/data/${type}-processed.txt"
            
          echo "âœ… Generated optimized ${type}.mrs"
        done
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f *.yaml *.txt

    - name: Commit and push changes
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add rules/
        if git diff-index --quiet HEAD --; then
          echo "ğŸŸ¢ No changes to commit"
        else
          git commit -m "ğŸ¤– Update optimized MRS rules: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          git push
          echo "ğŸš€ Pushed optimized rules to repository"
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mrs-rules
        path: rules/
        retention-days: 3

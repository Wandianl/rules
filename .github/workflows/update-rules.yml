name: Generate Optimized MRS Rules

on:
  schedule:
    - cron: '0 0 * * *'  # 每天UTC时间00:00运行
  workflow_dispatch:     # 允许手动触发
  push:
    branches:
      - main

jobs:
  generate-mrs-rules:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup environment
      run: |
        mkdir -p rules
        mkdir -p bin
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq file unzip
        
    - name: Download Mihomo Meta
      run: |
        # 获取最新版本的 Mihomo Meta
        LATEST_RELEASE=$(curl -sL https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | jq -r '.tag_name')
        echo "Latest release: $LATEST_RELEASE"
        ARCH="linux-amd64"  # 根据您的运行器架构调整
        
        # 下载 Mihomo Meta (使用压缩包格式)
        curl -sL "https://github.com/MetaCubeX/mihomo/releases/download/$LATEST_RELEASE/mihomo-$ARCH.zip" -o bin/mihomo.zip
        unzip bin/mihomo.zip -d bin/
        rm bin/mihomo.zip
        
        # 确保可执行文件存在并添加权限
        if [ -f "bin/mihomo" ]; then
          chmod +x bin/mihomo
        else
          # 尝试查找解压后的文件
          find bin/ -type f -executable -exec mv {} bin/mihomo \;
          chmod +x bin/mihomo
        fi
        
        # 添加到 PATH
        echo "$(pwd)/bin" >> $GITHUB_PATH
        echo "Mihomo version:"
        bin/mihomo -v

    - name: Download and convert rules
      run: |
        # 定义规则类型
        types=("direct" "proxy" "reject")
        
        for type in "${types[@]}"; do
          # 下载原始规则
          url="https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/${type}.txt"
          echo "📥 Downloading $url..."
          curl -s -o "${type}.yaml" "$url"
          
          # 提取域名并生成中间文件
          echo "🔄 Processing ${type} rules..."
          grep -E "^  - '[^']+'" "${type}.yaml" | \
            sed "s/^  - '//;s/'$//" | \
            awk '{
              if ($0 ~ /^\*/) {print $0}
              else {print "*." $0}
            }' > "${type}.txt"
            
          # 使用 Mihomo Meta 原生工具生成 MRS
          echo "⚙️ Generating MRS for ${type}..."
          bin/mihomo rule-set \
            -format text \
            -o "rules/${type}.mrs" \
            "${type}.txt"
            
          echo "✅ Generated optimized ${type}.mrs"
          # 显示生成的MRS文件信息
          file "rules/${type}.mrs"
        done
        
        # 清理临时文件
        rm -f direct.* proxy.* reject.*

    - name: Commit and push changes
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add rules/
        if git diff-index --quiet HEAD --; then
          echo "🟢 No changes to commit"
        else
          git commit -m "🤖 Update optimized MRS rules: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          git push
          echo "🚀 Pushed optimized rules to repository"
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mrs-rules
        path: rules/
        retention-days: 3

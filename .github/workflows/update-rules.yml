name: Generate Optimized MRS Rules

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTCæ—¶é—´00:00è¿è¡Œ
  workflow_dispatch:     # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main

jobs:
  generate-mrs-rules:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup environment
      run: |
        mkdir -p rules
        mkdir -p bin
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq file wget
        
    - name: Detect architecture
      id: detect-arch
      run: |
        ARCH=$(uname -m)
        case $ARCH in
          x86_64) echo "ARCH=amd64" >> $GITHUB_ENV ;;
          aarch64) echo "ARCH=arm64" >> $GITHUB_ENV ;;
          *) echo "Unsupported architecture: $ARCH" && exit 1 ;;
        esac
        echo "Detected architecture: $ARCH"
        
    - name: Download Mihomo Meta
      run: |
        # è·å–æœ€æ–°ç‰ˆæœ¬çš„ Mihomo Meta
        LATEST_RELEASE=$(curl -sL https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | jq -r '.tag_name')
        echo "Latest release: $LATEST_RELEASE"
        
        # æ„å»ºæ­£ç¡®çš„ä¸‹è½½URL
        DL_URL="https://github.com/MetaCubeX/mihomo/releases/download/$LATEST_RELEASE/mihomo-linux-${{ env.ARCH }}.gz"
        echo "Download URL: $DL_URL"
        
        # ä¸‹è½½å¹¶è§£å‹
        wget -q "$DL_URL" -O bin/mihomo.gz
        
        # éªŒè¯æ–‡ä»¶ç±»å‹
        file bin/mihomo.gz || true
        
        # è§£å‹
        gzip -d bin/mihomo.gz || { echo "Failed to decompress file. Content:"; head bin/mihomo.gz; exit 1; }
        chmod +x bin/mihomo
        
        # éªŒè¯å¯æ‰§è¡Œæ–‡ä»¶
        echo "File type after decompression:"
        file bin/mihomo
        
        # æ·»åŠ åˆ° PATH
        echo "$(pwd)/bin" >> $GITHUB_PATH
        echo "Mihomo version:"
        bin/mihomo -v || echo "Version check not supported"

    - name: Download and convert rules
      run: |
        # å®šä¹‰è§„åˆ™ç±»å‹
        types=("direct" "proxy" "reject")
        
        for type in "${types[@]}"; do
          # ä¸‹è½½åŸå§‹è§„åˆ™
          url="https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/${type}.txt"
          echo "ğŸ“¥ Downloading $url..."
          curl -s -o "${type}.yaml" "$url"
          
          # æå–åŸŸåå¹¶ç”Ÿæˆä¸­é—´æ–‡ä»¶
          echo "ğŸ”„ Processing ${type} rules..."
          # ä½¿ç”¨æ›´å¯é çš„æå–æ–¹æ³•
          awk -F"'" '/^  - '\''/ {print $2}' "${type}.yaml" | \
            awk '{
              # å¤„ç†é€šé…ç¬¦
              if ($0 ~ /^\*\./) {
                print $0
              } else if ($0 ~ /^\./) {
                print "*" $0
              } else if ($0 ~ /^[a-zA-Z0-9.-]+$/) {
                print "*." $0
              } else {
                # å¤„ç†ç‰¹æ®Šæ ¼å¼
                gsub(/^['\''"]|['\''"]$/, "", $0)
                print "*." $0
              }
            }' > "${type}.txt"
            
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºç©º
          if [ ! -s "${type}.txt" ]; then
            echo "âš ï¸ Error: ${type}.txt is empty! Trying alternative extraction..."
            # å¤‡ç”¨æå–æ–¹æ³•
            grep -E "^  - '" "${type}.yaml" | sed "s/^  - '//;s/'$//" > "${type}.txt"
          fi
            
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä»ç„¶ä¸ºç©º
          if [ ! -s "${type}.txt" ]; then
            echo "âŒ Critical error: ${type}.txt is empty after all extraction attempts"
            echo "File content preview:"
            head "${type}.yaml"
            exit 1
          fi
            
          echo "First 3 domains:"
          head -3 "${type}.txt"
            
          # ä½¿ç”¨ Mihomo Meta åŸç”Ÿå·¥å…·ç”Ÿæˆ MRS
          echo "âš™ï¸ Generating MRS for ${type}..."
          bin/mihomo rule-set \
            -format text \
            -o "rules/${type}.mrs" \
            "${type}.txt"
            
          echo "âœ… Generated optimized ${type}.mrs"
          # æ˜¾ç¤ºç”Ÿæˆçš„MRSæ–‡ä»¶ä¿¡æ¯
          file "rules/${type}.mrs"
        done
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f direct.* proxy.* reject.*

    - name: Commit and push changes
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add rules/
        if git diff-index --quiet HEAD --; then
          echo "ğŸŸ¢ No changes to commit"
        else
          git commit -m "ğŸ¤– Update optimized MRS rules: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          git push
          echo "ğŸš€ Pushed optimized rules to repository"
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mrs-rules
        path: rules/
        retention-days: 3

name: Update MRS Rules

on:
  schedule:
    - cron: '0 0 * * *'  # 每天UTC 0点自动运行
  workflow_dispatch:     # 支持手动触发

jobs:
  convert:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        rulesets:
          - { src: direct.txt, dest: direct.mrs }
          - { src: proxy.txt, dest: proxy.mrs }
          - { src: reject.txt, dest: reject.mrs }
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 关键修复：拉取完整历史

    - name: Debug - Show Source URL
      run: |
        echo "源文件URL: https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/${{ matrix.rulesets.src }}"

    - name: Convert to MRS Format (强制生成测试规则)
      run: |
        # 下载源文件（带详细调试）
        curl -v "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/${{ matrix.rulesets.src }}" -o source.tmp 2> curl.log
        echo "=== 源文件行数 ==="
        wc -l source.tmp
        echo "=== 前5行内容 ==="
        head -n 5 source.tmp || echo "无法读取文件"

        # 强制生成测试内容（无论源文件是否有效）
        echo "#MRS-RULES-V1" > ${{ matrix.rulesets.dest }}
        echo "# Generated at: $(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> ${{ matrix.rulesets.dest }}
        echo "domain:example.com" >> ${{ matrix.rulesets.dest }}
        echo "domain-wildcard:test.example.com" >> ${{ matrix.rulesets.dest }}
        echo "# Total rules: 2" >> ${{ matrix.rulesets.dest }}

        # 如果源文件有效，追加真实规则
        if [ $(grep -v '^#' source.tmp | wc -l) -gt 0 ]; then
          echo "# 真实规则开始 ===" >> ${{ matrix.rulesets.dest }}
          grep -v '^#' source.tmp | head -n 5 >> ${{ matrix.rulesets.dest }}
        fi

        # 保留调试日志
        echo "=== curl日志 ==="
        cat curl.log

    - name: Commit changes (强制推送)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.name "mrs-generator-bot"
        git config --global user.email "mrs-generator@users.noreply.github.com"
        
        # 强制同步远程分支
        git fetch origin main
        git reset --hard origin/main
        
        # 添加并提交所有变更
        git add *.mrs
        git commit -m "强制更新MRS规则 [调试模式]" || echo "⚠️ 提交失败（但继续执行）"
        git push --force-with-lease origin main

name: Generate Rule Files for Conversion

on:
  schedule:
    - cron: '0 0 * * *'  # 每天UTC时间00:00运行
  workflow_dispatch:     # 允许手动触发
  push:
    branches:
      - main

jobs:
  generate-rule-files:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Generate rule files
      run: |
        # 创建规则目录
        mkdir -p rules
        
        # 定义规则类型
        types=("direct" "proxy" "reject")
        
        for type in "${types[@]}"; do
          # 下载原始规则
          url="https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/${type}.txt"
          echo "📥 Downloading $url..."
          curl -s -o "${type}.yaml" "$url"
          
          # 提取域名并生成中间文件
          echo "🔄 Generating ${type}-domains.txt..."
          # 使用可靠的提取方法
          grep -E "^  - '" "${type}.yaml" | sed "s/^  - '//;s/'$//" | \
            awk '{
              # 确保通配符格式
              if ($0 ~ /^\*\./) {
                print $0
              } else if ($0 ~ /^\./) {
                print "*" $0
              } else {
                print "*." $0
              }
            }' > "rules/${type}-domains.txt"
            
          echo "✅ Generated rules/${type}-domains.txt"
          echo "First 3 domains:"
          head -3 "rules/${type}-domains.txt"
        done
        
        # 清理临时文件
        rm -f *.yaml

    - name: Commit and push changes
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add rules/
        if git diff-index --quiet HEAD --; then
          echo "🟢 No changes to commit"
        else
          git commit -m "🤖 Update rule files: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          git push
          echo "🚀 Pushed rule files to repository"
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: rule-files
        path: rules/
        retention-days: 3

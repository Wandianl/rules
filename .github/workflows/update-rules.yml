name: Generate Optimized MRS Rules

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTCæ—¶é—´00:00è¿è¡Œ
  workflow_dispatch:     # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main

jobs:
  generate-mrs-rules:
    runs-on: ubuntu-latest
    container: ghcr.io/metacubex/mihomo:alpha
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Prepare environment
      run: |
        mkdir -p rules
        chmod 777 rules
        
    - name: Download and convert rules
      run: |
        # å®‰è£…å¿…è¦å·¥å…·
        apk add --no-cache curl jq
        
        # å®šä¹‰è§„åˆ™ç±»å‹
        types=("direct" "proxy" "reject")
        
        for type in "${types[@]}"; do
          # ä¸‹è½½åŸå§‹è§„åˆ™
          url="https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/${type}.txt"
          curl -s -o "${type}.yaml" "$url"
          
          # æå–åŸŸåå¹¶ç”Ÿæˆä¸­é—´æ–‡ä»¶
          grep -E "^  - '[^']+'" "${type}.yaml" | \
            sed "s/^  - '//;s/'$//" | \
            awk '{
              if ($0 ~ /^\*/) {print $0}
              else {print "*." $0}
            }' > "${type}.txt"
            
          # ä½¿ç”¨ Mihomo Meta åŸç”Ÿå·¥å…·ç”Ÿæˆ MRS
          mihomo rule-set \
            -format text \
            -o "rules/${type}.mrs" \
            "${type}.txt"
            
          echo "âœ… Generated optimized ${type}.mrs"
        done
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f direct.* proxy.* reject.*
        
        # éªŒè¯ MRS æ–‡ä»¶
        echo "ğŸ” Validating MRS files:"
        file rules/*.mrs

    - name: Commit and push changes
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add rules/
        if git diff-index --quiet HEAD --; then
          echo "ğŸŸ¢ No changes to commit"
        else
          git commit -m "ğŸ¤– Update optimized MRS rules: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          git push
          echo "ğŸš€ Pushed optimized rules to repository"
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: mrs-rules
        path: rules/
